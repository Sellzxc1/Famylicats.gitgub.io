<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Мультиплеерная игра с джойстиком</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #4CAF50; /* Зеленое поле */
            touch-action: none;
            font-family: Arial, sans-serif;
        }
        
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
        }
        
        #joystick {
            position: fixed;
            bottom: 50px;
            left: 50px;
            width: 100px;
            height: 100px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            display: none;
        }
        
        #joystickKnob {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            top: 25px;
            left: 25px;
        }
        
        .player-name {
            position: absolute;
            color: white;
            text-shadow: 1px 1px 2px black;
            font-weight: bold;
            text-align: center;
            width: 100px;
            margin-left: -50px;
            top: -20px;
        }
        
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #loginForm {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        #loginForm input, #loginForm button {
            margin: 10px 0;
            padding: 8px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div id="loginOverlay">
        <div id="loginForm">
            <h2>Введите ваше имя</h2>
            <input type="text" id="playerNameInput" placeholder="Ваше имя" maxlength="10">
            <button id="startButton">Начать игру</button>
        </div>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    <div id="joystick">
        <div id="joystickKnob"></div>
    </div>

    <script>
        // Инициализация canvas
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Настройка размеров canvas
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Игрок
        const player = {
            id: null,
            x: canvas.width / 2,
            y: canvas.height / 2,
            width: 50,
            height: 50,
            speed: 5,
            name: "Игрок",
            color: "#FF5722"
        };
        
        // Другие игроки
        const otherPlayers = {};
        
        // WebSocket соединение
        let socket = null;
        const serverUrl = "wss://your-websocket-server.com"; // Замените на ваш URL WebSocket сервера
        
        // Загрузка текстуры игрока
        const playerImage = new Image();
        playerImage.src = 'player.png';
        playerImage.onerror = function() {
            // Если изображение не загрузилось, используем цветной прямоугольник
            console.log("Изображение player.png не найдено, используется цветной прямоугольник");
            player.useImage = false;
        };
        player.useImage = true;
        
        // Джойстик
        const joystick = {
            element: document.getElementById('joystick'),
            knob: document.getElementById('joystickKnob'),
            active: false,
            startX: 0,
            startY: 0,
            moveX: 0,
            moveY: 0,
            radius: 50
        };
        
        // Обработчики событий для джойстика
        joystick.element.addEventListener('touchstart', handleJoystickStart);
        joystick.element.addEventListener('touchmove', handleJoystickMove);
        joystick.element.addEventListener('touchend', handleJoystickEnd);
        
        function handleJoystickStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = joystick.element.getBoundingClientRect();
            
            joystick.active = true;
            joystick.startX = rect.left + joystick.radius;
            joystick.startY = rect.top + joystick.radius;
            
            updateJoystickKnob(touch.clientX, touch.clientY);
        }
        
        function handleJoystickMove(e) {
            e.preventDefault();
            if (!joystick.active) return;
            
            const touch = e.touches[0];
            updateJoystickKnob(touch.clientX, touch.clientY);
        }
        
        function handleJoystickEnd(e) {
            e.preventDefault();
            joystick.active = false;
            joystick.moveX = 0;
            joystick.moveY = 0;
            joystick.knob.style.transform = 'translate(25px, 25px)';
        }
        
        function updateJoystickKnob(touchX, touchY) {
            const dx = touchX - joystick.startX;
            const dy = touchY - joystick.startY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < joystick.radius) {
                joystick.moveX = dx / joystick.radius;
                joystick.moveY = dy / joystick.radius;
                joystick.knob.style.transform = `translate(${dx + 25}px, ${dy + 25}px)`;
            } else {
                const angle = Math.atan2(dy, dx);
                joystick.moveX = Math.cos(angle);
                joystick.moveY = Math.sin(angle);
                joystick.knob.style.transform = `translate(${joystick.moveX * joystick.radius + 25}px, ${joystick.moveY * joystick.radius + 25}px)`;
            }
        }
        
        // Показать джойстик на мобильных устройствах
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        if (isMobile()) {
            joystick.element.style.display = 'block';
        }
        
        // Отрисовка игрока
        function drawPlayer(p) {
            if (player.useImage && playerImage.complete && p.id === player.id) {
                ctx.drawImage(playerImage, p.x - p.width / 2, p.y - p.height / 2, p.width, p.height);
            } else {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - p.width / 2, p.y - p.height / 2, p.width, p.height);
            }
            
            // Отрисовка имени игрока
            ctx.fillStyle = 'white';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(p.name, p.x, p.y - p.height / 2 - 10);
        }
        
        // Игровой цикл
        function gameLoop() {
            // Очистка canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Движение игрока
            if (joystick.active) {
                player.x += joystick.moveX * player.speed;
                player.y += joystick.moveY * player.speed;
                
                // Границы поля
                player.x = Math.max(player.width / 2, Math.min(canvas.width - player.width / 2, player.x));
                player.y = Math.max(player.height / 2, Math.min(canvas.height - player.height / 2, player.y));
                
                // Отправка позиции на сервер
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: "position",
                        x: player.x,
                        y: player.y
                    }));
                }
            }
            
            // Отрисовка всех игроков
            drawPlayer(player);
            for (const id in otherPlayers) {
                drawPlayer(otherPlayers[id]);
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Обработчик входа в игру
        document.getElementById('startButton').addEventListener('click', function() {
            const nameInput = document.getElementById('playerNameInput');
            if (nameInput.value.trim() === '') {
                alert('Пожалуйста, введите ваше имя');
                return;
            }
            
            player.name = nameInput.value.trim().substring(0, 10);
            document.getElementById('loginOverlay').style.display = 'none';
            
            // Подключение к WebSocket серверу
            connectToServer();
        });
        
        // Подключение к серверу
        function connectToServer() {
            // В реальном проекте замените на ваш WebSocket URL
            // Для локального тестирования: ws://localhost:8080
            socket = new WebSocket(serverUrl);
            
            socket.onopen = function() {
                console.log("Подключено к серверу");
                
                // Отправляем информацию о новом игроке
                socket.send(JSON.stringify({
                    type: "join",
                    name: player.name,
                    color: player.color
                }));
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                switch(data.type) {
                    case "init":
                        player.id = data.id;
                        player.x = data.x;
                        player.y = data.y;
                        break;
                        
                    case "players":
                        // Обновляем информацию о других игроках
                        for (const id in data.players) {
                            if (id !== player.id) {
                                otherPlayers[id] = data.players[id];
                            }
                        }
                        break;
                        
                    case "join":
                        // Новый игрок подключился
                        if (data.id !== player.id) {
                            otherPlayers[data.id] = {
                                id: data.id,
                                x: data.x,
                                y: data.y,
                                width: player.width,
                                height: player.height,
                                name: data.name,
                                color: data.color
                            };
                        }
                        break;
                        
                    case "position":
                        // Обновление позиции игрока
                        if (data.id !== player.id && otherPlayers[data.id]) {
                            otherPlayers[data.id].x = data.x;
                            otherPlayers[data.id].y = data.y;
                        }
                        break;
                        
                    case "leave":
                        // Игрок отключился
                        delete otherPlayers[data.id];
                        break;
                }
            };
            
            socket.onclose = function() {
                console.log("Отключено от сервера");
                // Можно добавить переподключение
            };
            
            socket.onerror = function(error) {
                console.error("Ошибка WebSocket:", error);
            };
        }
        
        // Запуск игры после загрузки
        window.addEventListener('load', function() {
            // Показываем форму входа
            document.getElementById('loginOverlay').style.display = 'flex';
        });
    </script>
</body>
</html>
